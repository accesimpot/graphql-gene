name: Release

on:
  push:
    branches:
      - main
      - beta

# https://docs.npmjs.com/trusted-publishers#step-2-configure-your-cicd-workflow
permissions:
  id-token: write # Required for OIDC
  contents: write # Required for semantic-release to push commits, tags, and create releases
  issues: write # Required by @semantic-release/github to comment on released issues
  pull-requests: write # Required by @semantic-release/github to comment on released pull requests

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    env:
      CI_FORCE_RELEASE_RUN: ${{ secrets.CI_FORCE_RELEASE_RUN }}

    steps:
      # https://semantic-release.gitbook.io/semantic-release/recipes/ci-configurations/github-actions#pushing-package.json-changes-to-your-repository
      - name: Checkout branch ðŸ›Ž
        uses: actions/checkout@v4
        with:
          persist-credentials: false # Required per semantic-release docs for GitHub Actions
          fetch-depth: 0

      - name: Get GitHub App token ðŸ”
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: graphql-gene

      # https://nx.dev/packages/nx/documents/affected
      - name: Set SHAs for `nx affected` commands
        id: setSHAs
        uses: nrwl/nx-set-shas@v4

      - name: Install pnpm ðŸ‘¨ðŸ»â€ðŸ’»
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup node env ðŸ—
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'pnpm'

      - name: Install dependencies ðŸ‘¨ðŸ»â€ðŸ’»
        run: pnpm install --prod=false

      - name: Any change affecting the public packagesâ”
        id: public-package-affected
        # Make sure the job fails with exit code 1 if the nx command fails
        run: |
          projects=$(pnpm --silent nx show projects --affected --exclude=dev-* || echo 'error')
          projects+=$(git diff --name-only --diff-filter=d ${{ steps.setSHAs.outputs.base }} -- README.md || echo 'error')
          projects+=$(git diff --name-only --diff-filter=d ${{ steps.setSHAs.outputs.base }} -- package.json || echo 'error')

          projects_array=($projects)
          [[ ${projects_array[*]} =~ 'error' ]] && exit 1

          echo "count=${#projects_array[@]}" >> $GITHUB_OUTPUT

      - name: Build packages ðŸ“¦
        if: steps.public-package-affected.outputs.count > 0 || ${{ env.CI_FORCE_RELEASE_RUN }} == 'true'
        run: pnpm build

      #
      # A release is made if the prefix is feat, fix, perf, chore(deps), or docs(README)
      #
      # { type: 'feat', release: 'minor' },
      # { type: 'fix', release: 'patch' },
      # { type: 'perf', release: 'patch' },
      # { type: 'chore', scope: 'deps', release: 'patch' },
      # { type: 'docs', scope: 'README', release: 'patch' },
      #
      # See https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-angular#type
      #
      # Available types:
      #   - feat: A new feature
      #   - fix: A bug fix
      #   - docs: Documentation only changes
      #   - style: Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc)
      #   - refactor: A code change that neither fixes a bug nor adds a feature
      #   - perf: A code change that improves performance
      #   - test: Adding missing tests or correcting existing tests
      #   - build: Changes that affect the build system or external dependencies (example scopes: gulp, broccoli, npm)
      #   - ci: Changes to our CI configuration files and scripts (example scopes: Travis, Circle, BrowserStack, SauceLabs)
      #   - chore: Other changes that don't modify src or test files
      #   - revert: Reverts a previous commit
      #
      - name: Release
        if: steps.public-package-affected.outputs.count > 0 || ${{ env.CI_FORCE_RELEASE_RUN }} == 'true'
        env:
          # Give semantic-release the short-lived GitHub App token
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: pnpm -r --filter='!dev-*' --workspace-concurrency=1 exec semantic-release -e semantic-release-monorepo
